clc
clear all
close all

I1 = imread("simpsons.jpeg");
I2 = imread("bus.jpeg");
p1 = [1,1;1000,1;1,1500;1000,1500];
p2 = [583,212;799,231;596,522;808,472];

% assume 2X2 transformation: 3 points
A = [p1(1,1),p1(1,2),0,0;0,0,p1(1,1),p1(1,2);...
     p1(2,1),p1(2,2),0,0;0,0,p1(2,1),p1(2,2);...
     p1(3,1),p1(3,2),0,0;0,0,p1(3,1),p1(3,2)];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2)];
T = (A'*A)\(A'*B);
T = [T(1),T(2);T(3),T(4)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(1)
imshow(I3);impixelinfo

% assume 2X2 transformation: 4 points
A = [p1(1,1),p1(1,2),0,0;0,0,p1(1,1),p1(1,2);...
     p1(2,1),p1(2,2),0,0;0,0,p1(2,1),p1(2,2);...
     p1(3,1),p1(3,2),0,0;0,0,p1(3,1),p1(3,2);...
     p1(4,1),p1(4,2),0,0;0,0,p1(4,1),p1(4,2)];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2);...
     p2(4,1);p2(4,2)];
T = (A'*A)\(A'*B);
T = [T(1),T(2);T(3),T(4)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(2)
imshow(I3);impixelinfo

% assume 3X2 affine transformation: 3 points
A = [p1(1,1),p1(1,2),1,0,0,0;0,0,0,p1(1,1),p1(1,2),1;...
     p1(2,1),p1(2,2),1,0,0,0;0,0,0,p1(2,1),p1(2,2),1;...
     p1(3,1),p1(3,2),1,0,0,0;0,0,0,p1(3,1),p1(3,2),1];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2)];
T = (A'*A)\(A'*B);
T = [T(1),T(2),T(3);T(4),T(5),T(6)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j;1]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(3)
imshow(I3);impixelinfo

% assume 3X2 affine transformation: 4 points
A = [p1(1,1),p1(1,2),1,0,0,0;0,0,0,p1(1,1),p1(1,2),1;...
     p1(2,1),p1(2,2),1,0,0,0;0,0,0,p1(2,1),p1(2,2),1;...
     p1(3,1),p1(3,2),1,0,0,0;0,0,0,p1(3,1),p1(3,2),1;...
     p1(4,1),p1(4,2),1,0,0,0;0,0,0,p1(4,1),p1(4,2),1];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2);...
     p2(4,1);p2(4,2)];
T = (A'*A)\(A'*B);
T = [T(1),T(2),T(3);T(4),T(5),T(6)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j;1]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(4)
imshow(I3);impixelinfo

% assume 3X3 homography    : 4 points
A = [p1(1,1),p1(1,2),1,0,0,0,-p1(1,1)*p2(1,1),-p1(1,2)*p2(1,1);0,0,0,p1(1,1),p1(1,2),1,-p1(1,1)*p2(1,2),-p1(1,2)*p2(1,2);...
     p1(2,1),p1(2,2),1,0,0,0,-p1(2,1)*p2(2,1),-p1(2,2)*p2(2,1);0,0,0,p1(2,1),p1(2,2),1,-p1(2,1)*p2(2,2),-p1(2,2)*p2(2,2);...
     p1(3,1),p1(3,2),1,0,0,0,-p1(3,1)*p2(3,1),-p1(3,2)*p2(3,1);0,0,0,p1(3,1),p1(3,2),1,-p1(3,1)*p2(3,2),-p1(3,2)*p2(3,2);...
     p1(4,1),p1(4,2),1,0,0,0,-p1(4,1)*p2(4,1),-p1(4,2)*p2(4,1);0,0,0,p1(4,1),p1(4,2),1,-p1(4,1)*p2(4,2),-p1(4,2)*p2(4,2)];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2);...
     p2(4,1);p2(4,2)];
T = (A'*A)\(A'*B);
T = [T(1),T(2),T(3);T(4),T(5),T(6);T(7),T(8),1];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = T*[i;j;1];
        p = ceil(p./p(3));
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(5)
imshow(I3);impixelinfo

% assume 3X3 non-homogeneous transformation    : 3 points
A = [p1(1,1),p1(1,2),1,0,0,0,0,0,0;0,0,0,p1(1,1),p1(1,2),1,0,0,0;0,0,0,0,0,0,p1(1,1),p1(1,2),1;...
     p1(2,1),p1(2,2),1,0,0,0,0,0,0;0,0,0,p1(2,1),p1(2,2),1,0,0,0;0,0,0,0,0,0,p1(2,1),p1(2,2),1;...
     p1(3,1),p1(3,2),1,0,0,0,0,0,0;0,0,0,p1(3,1),p1(3,2),1,0,0,0;0,0,0,0,0,0,p1(3,1),p1(3,2),1];
B = [p2(1,1);p2(1,2);1;...
     p2(2,1);p2(2,2);1;...
     p2(3,1);p2(3,2);1];
T = (A'*A)\(A'*B);
T = [T(1),T(2),T(3);T(4),T(5),T(6);T(7),T(8),T(9)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j;1]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(6)
imshow(I3);impixelinfo

% assume 3X3 non-homogeneous transformation    : 4 points
A = [p1(1,1),p1(1,2),1,0,0,0,0,0,0;0,0,0,p1(1,1),p1(1,2),1,0,0,0;0,0,0,0,0,0,p1(1,1),p1(1,2),1;...
     p1(2,1),p1(2,2),1,0,0,0,0,0,0;0,0,0,p1(2,1),p1(2,2),1,0,0,0;0,0,0,0,0,0,p1(2,1),p1(2,2),1;...
     p1(3,1),p1(3,2),1,0,0,0,0,0,0;0,0,0,p1(3,1),p1(3,2),1,0,0,0;0,0,0,0,0,0,p1(3,1),p1(3,2),1;...
     p1(4,1),p1(4,2),1,0,0,0,0,0,0;0,0,0,p1(4,1),p1(4,2),1,0,0,0;0,0,0,0,0,0,p1(4,1),p1(4,2),1];
B = [p2(1,1);p2(1,2);1;...
     p2(2,1);p2(2,2);1;...
     p2(3,1);p2(3,2);1;...
     p2(4,1);p2(4,2);1];
T = (A'*A)\(A'*B);
T = [T(1),T(2),T(3);T(4),T(5),T(6);T(7),T(8),T(9)];
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = ceil(T*[i;j;1]);
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(7)
imshow(I3);impixelinfo

% assume 3X3 homography DLT    : 4 points
p1o = p1; p2o = p2; 
mp1 = mean(p1); mp2 = mean(p2);
s1 = mean(sqrt(sum((p1-mp1)'.^2))); s2 = mean(sqrt(sum((p2-mp2)'.^2)));
T1 = [sqrt(2)/s1,0,0;0,sqrt(2)/s1,0;0,0,1]*[1,0,-mp1(1);0,1,-mp1(2);0,0,1];
T2 = [sqrt(2)/s2,0,0;0,sqrt(2)/s2,0;0,0,1]*[1,0,-mp2(1);0,1,-mp2(2);0,0,1];
p1 = T1*[p1';ones(1,4)]; p2 = T2*[p2';ones(1,4)];
p1 = p1(1:2,:)'; p2 = p2(1:2,:)';
A = [p1(1,1),p1(1,2),1,0,0,0,-p1(1,1)*p2(1,1),-p1(1,2)*p2(1,1);0,0,0,p1(1,1),p1(1,2),1,-p1(1,1)*p2(1,2),-p1(1,2)*p2(1,2);...
     p1(2,1),p1(2,2),1,0,0,0,-p1(2,1)*p2(2,1),-p1(2,2)*p2(2,1);0,0,0,p1(2,1),p1(2,2),1,-p1(2,1)*p2(2,2),-p1(2,2)*p2(2,2);...
     p1(3,1),p1(3,2),1,0,0,0,-p1(3,1)*p2(3,1),-p1(3,2)*p2(3,1);0,0,0,p1(3,1),p1(3,2),1,-p1(3,1)*p2(3,2),-p1(3,2)*p2(3,2);...
     p1(4,1),p1(4,2),1,0,0,0,-p1(4,1)*p2(4,1),-p1(4,2)*p2(4,1);0,0,0,p1(4,1),p1(4,2),1,-p1(4,1)*p2(4,2),-p1(4,2)*p2(4,2)];
B = [p2(1,1);p2(1,2);...
     p2(2,1);p2(2,2);...
     p2(3,1);p2(3,2);...
     p2(4,1);p2(4,2)];
AA = [A,-B];
[U,S,V] = svd(AA); %[VV,DD] = eig(AA'*AA); VV(1)=V(:,9)
T = V(:,9);%(A'*A)\(A'*B);
T = pinv(T2)*[T(1),T(2),T(3);T(4),T(5),T(6);T(7),T(8),T(9)]*T1;
I3 = I2;
%apply transformation
for i=1:size(I1,2)
    for j=1:size(I1,1)
        p = T*[i;j;1];
        p = ceil(p./p(3));
        I3(p(2),p(1),:) = I1(j,i,:);
    end
end
figure(8)
imshow(I3);impixelinfo









